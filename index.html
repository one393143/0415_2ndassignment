<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NBA Passing Network Analysis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <style>
        body {
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .header {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .filter-section {
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .season-header {
            cursor: pointer;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .team-header {
            cursor: pointer;
            padding: 8px;
            background-color: #f1f3f5;
            border-radius: 5px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
        }
        .plot-category {
            margin-left: 20px;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .plot-links {
            margin-left: 40px;
            margin-bottom: 10px;
        }
        .team-stats {
            margin-left: 40px;
            margin-bottom: 15px;
            padding: 8px;
            background-color: #f8f9fa;
            border-radius: 5px;
            font-size: 0.9em;
        }
        .stats-table {
            width: 100%;
            margin-bottom: 0;
        }
        .stats-table td {
            padding: 3px 10px;
        }
        .stats-table td:first-child {
            font-weight: bold;
            width: 180px;
        }
        .search-container {
            margin-bottom: 20px;
        }
        .team-logo {
            width: 24px;
            height: 24px;
            margin-right: 10px;
        }
        .hidden {
            display: none;
        }
        .csv-link {
            background-color: #e2f0d9;
            padding: 5px 10px;
            border-radius: 3px;
            text-decoration: none;
            color: #2e7d32;
            margin-right: 10px;
            display: inline-block;
        }
        .csv-link:hover {
            background-color: #c5e1a5;
        }
        .all-seasons-csv {
            background-color: #d1c4e9;
            padding: 10px 15px;
            border-radius: 5px;
            text-decoration: none;
            color: #4527a0;
            font-weight: bold;
            display: inline-block;
            margin-bottom: 20px;
        }
        .all-seasons-csv:hover {
            background-color: #b39ddb;
        }
        .filter-btn {
            margin-left: 10px;
        }
        .team-content {
            margin-left: 20px;
            margin-bottom: 15px;
        }
        .season-content {
            margin-bottom: 20px;
        }
        .button-group {
            display: flex;
            gap: 10px;
        }
        .chevron-icon {
            margin-right: 10px;
        }
        .dataset-tab {
            cursor: pointer;
            padding: 10px 15px;
            border-radius: 5px 5px 0 0;
            background-color: #dee2e6;
            margin-right: 5px;
        }
        .dataset-tab.active {
            background-color: #ffffff;
            border: 1px solid #dee2e6;
            border-bottom: none;
        }
        .dataset-content {
            border: 1px solid #dee2e6;
            border-radius: 0 5px 5px 5px;
            padding: 20px;
            background-color: #ffffff;
        }
        .modal-xl {
            max-width: 90%;
        }
        .download-btn {
            margin-bottom: 15px;
        }
        .error-message {
            color: #dc3545;
            padding: 10px;
            background-color: #f8d7da;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .loading-spinner {
            text-align: center;
            padding: 20px;
        }
        .mock-data-notice {
            background-color: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .team-data-table {
            width: 100%;
            margin-bottom: 15px;
        }
        .network-indicators-link {
            margin-left: 40px;
            margin-bottom: 15px;
            display: block;
            background-color: #e3f2fd;
            padding: 5px 10px;
            border-radius: 3px;
            text-decoration: none;
            color: #1565c0;
            width: fit-content;
        }
        .network-indicators-link:hover {
            background-color: #bbdefb;
        }
		.info-section {
		    background-color: #f8f9fa;
		    border-radius: 5px;
		    margin-bottom: 20px;
		    border: 1px solid #dee2e6;
		}
		.info-header {
		    cursor: pointer;
		    padding: 15px;
		    background-color: #e9ecef;
		    border-radius: 5px 5px 0 0;
		    display: flex;
		    align-items: center;
		}
		.info-content {
		    padding: 20px;
		}
		.info-content h5 {
		    margin-top: 20px;
		    margin-bottom: 10px;
		    color: #0d6efd;
		}
		.info-content h5:first-child {
		    margin-top: 0;
		}

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>NBA Passing Network Analysis_2020-21 ~ 2024-25</h1>
            <p>NBA passing network analysis indicators / Visualization of team passing networks / Community detection</p>
        </div>

		        <!-- 說明區塊 -->
		<div class="container mb-4">
		    <div class="info-section">
		        <div class="info-header" onclick="toggleSection('info-section')">
		            <i class="bi bi-chevron-right chevron-icon"></i>
		            <h4 class="d-inline">About This Project</h4>
		        </div>
		        <div id="info-section" class="info-content hidden">
		            <div class="row">
		                <div class="col-md-12">
							<h5>Creator</h5>
							<p>C.T. Chin</p>
							<p><small>This project was developed with AI assistance using Monica, with Claude selected as the primary language model.</small></p>

		                    
		                    <h5>Data Source</h5>
		                    <p>NBA API - <a href="https://github.com/swar/nba_api" target="_blank">nba_api</a></p>
		                    
		                    <h5>Data Processing</h5>
		                    <p>Data processed using R programming language</p>
		                    
		                    <h5>Data Description</h5>
		                    <p>This project analyzes NBA passing networks based on the NBA's tracking data from the Passes Dashboard. The data represents the total number of passes from one player to another during a season. Each edge in the network represents the cumulative number of passes between two players throughout a season.</p>
		                    
		                    <h5>How to Use This Tool</h5>
		                    <p>This tool is structured as follows:</p>
		                    <ul>
		                        <li><strong>Data Sets:</strong> Choose between "All Passes" (complete passing data) or "Filtered Passes" (only players with 40+ games and edges with 50+ passes)</li>
		                        <li><strong>Seasons:</strong> Select from available NBA seasons (2020-21 to 2024-25)</li>
		                        <li><strong>Teams:</strong> Browse or search for specific NBA teams</li>
		                        <li><strong>Visualizations:</strong> For each team, access network plots, community detection, and hierarchy analysis</li>
		                        <li><strong>Network Metrics:</strong> View detailed network indicators for each team or entire seasons</li>
		                    </ul>
		                    <p>Use the filters at the top of each dataset section to search for specific teams, seasons, or plot types. The "Expand All" and "Collapse All" buttons help navigate through the content.</p>
		                    
		                    <h5>Network Indicators Explained</h5>
		                    <table class="table table-striped table-bordered">
		                        <thead>
		                            <tr>
		                                <th>Indicator</th>
		                                <th>Description</th>
		                                <th>Interpretation in Passing Networks</th>
		                            </tr>
		                        </thead>
		                        <tbody>
		                            <tr>
		                                <td>nodes</td>
		                                <td>Number of vertices in the network</td>
		                                <td>Total number of players in the team's rotation</td>
		                            </tr>
		                            <tr>
		                                <td>edges</td>
		                                <td>Number of connections in the network</td>
		                                <td>Total number of unique passing connections between players</td>
		                            </tr>
		                            <tr>
		                                <td>density</td>
		                                <td>Proportion of potential connections that are actual connections</td>
		                                <td>Higher values indicate more interconnected passing patterns; lower values suggest more specialized passing roles</td>
		                            </tr>
		                            <tr>
		                                <td>vertex_connectivity</td>
		                                <td>Minimum number of vertices needed to remove to disconnect the network</td>
		                                <td>Higher values indicate more robust passing networks that can withstand player absences</td>
		                            </tr>
		                            <tr>
		                                <td>edge_connectivity</td>
		                                <td>Minimum number of edges needed to remove to disconnect the network</td>
		                                <td>Higher values indicate more redundant passing pathways</td>
		                            </tr>
		                            <tr>
		                                <td>num_component</td>
		                                <td>Number of connected components</td>
		                                <td>Ideally 1; more components suggest disconnected player groups</td>
		                            </tr>
		                            <tr>
		                                <td>max_component_size</td>
		                                <td>Size of the largest connected component</td>
		                                <td>Closer to total nodes indicates more integrated team play</td>
		                            </tr>
		                            <tr>
		                                <td>biconnected_components</td>
		                                <td>Number of biconnected components</td>
		                                <td>Fewer components suggest more robust passing structures</td>
		                            </tr>
		                            <tr>
		                                <td>cohesive_blocks</td>
		                                <td>Number of cohesive blocks in the network</td>
		                                <td>More blocks indicate more hierarchical team structure</td>
		                            </tr>
		                            <tr>
		                                <td>max_cohesion</td>
		                                <td>Maximum cohesion value in the network</td>
		                                <td>Higher values indicate stronger core passing groups</td>
		                            </tr>
		                            <tr>
		                                <td>cent_indegree</td>
		                                <td>Centralization of incoming connections</td>
		                                <td>Higher values indicate team passing is focused toward specific players</td>
		                            </tr>
		                            <tr>
		                                <td>cent_outdegree</td>
		                                <td>Centralization of outgoing connections</td>
		                                <td>Higher values indicate passing originates from specific players</td>
		                            </tr>
		                            <tr>
		                                <td>cent_inclo</td>
		                                <td>Centralization of incoming closeness</td>
		                                <td>Higher values indicate some players are primary pass receivers</td>
		                            </tr>
		                            <tr>
		                                <td>cent_outclo</td>
		                                <td>Centralization of outgoing closeness</td>
		                                <td>Higher values indicate some players are primary pass distributors</td>
		                            </tr>
		                            <tr>
		                                <td>cent_betw</td>
		                                <td>Betweenness centralization</td>
		                                <td>Higher values indicate presence of key passing intermediaries</td>
		                            </tr>
		                            <tr>
		                                <td>centr_eigen</td>
		                                <td>Eigenvector centralization</td>
		                                <td>Higher values indicate hierarchical influence in the passing network</td>
		                            </tr>
		                            <tr>
		                                <td>walktrap_communities</td>
		                                <td>Number of communities detected by Walktrap algorithm</td>
		                                <td>More communities suggest distinct passing groups within team</td>
		                            </tr>
		                            <tr>
		                                <td>walktrap_modularity</td>
		                                <td>Modularity score for Walktrap communities</td>
		                                <td>Higher values indicate stronger community structure</td>
		                            </tr>
		                            <tr>
		                                <td>edge_betweenness_communities</td>
		                                <td>Number of communities detected by Edge Betweenness algorithm</td>
		                                <td>More communities suggest distinct passing groups based on critical passing paths</td>
		                            </tr>
		                            <tr>
		                                <td>edge_betweenness_modularity</td>
		                                <td>Modularity score for Edge Betweenness communities</td>
		                                <td>Higher values indicate stronger community structure</td>
		                            </tr>
		                            <tr>
		                                <td>louvain_communities</td>
		                                <td>Number of communities detected by Louvain algorithm</td>
		                                <td>More communities suggest distinct passing groups optimized for modularity</td>
		                            </tr>
		                            <tr>
		                                <td>louvain_modularity</td>
		                                <td>Modularity score for Louvain communities</td>
		                                <td>Higher values indicate stronger community structure</td>
		                            </tr>
		                            <tr>
		                                <td>best_modularity</td>
		                                <td>Highest modularity score among all community detection methods</td>
		                                <td>Higher values indicate stronger overall community structure</td>
		                            </tr>
		                            <tr>
		                                <td>tau_rankedcluster</td>
		                                <td>Ranked clustering coefficient</td>
		                                <td>Measure of hierarchical structure in passing patterns</td>
		                            </tr>
		                            <tr>
		                                <td>tau_cluster</td>
		                                <td>Clustering coefficient tau</td>
		                                <td>Measure of local clustering in passing patterns</td>
		                            </tr>
		                            <tr>
		                                <td>tau_balance</td>
		                                <td>Balance coefficient tau</td>
		                                <td>Measure of balance in passing structure</td>
		                            </tr>
		                        </tbody>
		                    </table>
		                    
		                    <h5>Visualization Types</h5>
		                    <p><strong>Network Plots:</strong> In these visualizations, circles represent players and lines represent passes between players. Larger circles indicate players with more seasons of experience, while thicker lines represent higher passing volume during the season.</p>
		                    
		                    <p><strong>Community Detection:</strong> These plots show different algorithms' attempts to identify natural groupings of players based on passing patterns. Different colors represent different detected communities. The three methods (Walktrap, Edge Betweenness, and Louvain) use different approaches to identify these communities.</p>
		                    
		                    <p><strong>Hierarchy Analysis: Cohesive Blocks:</strong> These visualizations represent the hierarchical structure of the team's passing network. They identify nested groups of players with increasing levels of interconnectedness. The blocks at higher levels represent more cohesive subgroups within the team, showing which players form the most tightly connected passing units.</p>
		                </div>
		            </div>
		        </div>
		    </div>
		</div>


        <!-- 資料集選擇標籤 -->
        <div class="dataset-tabs">
            <div class="d-flex">
                <div id="tab-no-filter" class="dataset-tab active" onclick="switchDataset('no-filter')">
                    All Passes
                </div>
                <div id="tab-filtered" class="dataset-tab" onclick="switchDataset('filtered')">
                    Filtered Passes (Players with 40+ Games，Edges of 50+ Passes)
                </div>
            </div>
        </div>

        <!-- 無篩選資料內容 -->
        <div id="content-no-filter" class="dataset-content">

			<div class="all-seasons-link mb-3">
			    <a href="javascript:void(0);" class="all-seasons-csv" onclick="showCSVData('all_passes/all_seasons_network_metrics.csv', 'All Seasons Network Metrics (All Passes)')">
			        <i class="bi bi-file-earmark-spreadsheet"></i> View All Seasons Network Metrics (All Passes)
			    </a>
			</div>

            
            <div class="filter-section">
                <div class="row">
                    <div class="col-md-4">
                        <input type="text" id="teamSearch-no-filter" class="form-control" placeholder="Search for teams...">
                    </div>
                    <div class="col-md-3">
                        <select id="seasonFilter-no-filter" class="form-select">
                            <option value="all">All Seasons</option>
                            <option value="2019-20">2024-25</option>
                            <option value="2023-24">2023-24</option>
                            <option value="2022-23">2022-23</option>
                            <option value="2021-22">2021-22</option>
                            <option value="2020-21">2020-21</option>                            
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select id="plotTypeFilter-no-filter" class="form-select">
                            <option value="all">All Plot Types</option>
                            <option value="network">Network Plots</option>
                            <option value="community">Community Plots</option>
                            <option value="hierarchy">Hierarchy Plots</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button id="applyFilters-no-filter" class="btn btn-primary">Apply Filters</button>
                    </div>
                </div>
                <div class="mt-2 button-group">
                    <button id="expandAll-no-filter" class="btn btn-sm btn-outline-secondary">Expand All</button>
                    <button id="collapseAll-no-filter" class="btn btn-sm btn-outline-secondary">Collapse All</button>
                </div>
            </div>

            <div id="seasons-no-filter">
                <!-- 動態生成賽季內容 -->
            </div>
        </div>

        <!-- 已篩選資料內容 -->
        <div id="content-filtered" class="dataset-content hidden">
            <div class="all-seasons-link mb-3">
                <a href="#" class="all-seasons-csv" onclick="showCSVData('filtered_passes/all_seasons_network_metrics.csv', 'All Seasons Network Metrics (Filtered Passes)')">
                    <i class="bi bi-file-earmark-spreadsheet"></i> View All Seasons Network Metrics (Filtered Passes)
                </a>
            </div>
            
            <div class="filter-section">
                <div class="row">
                    <div class="col-md-4">
                        <input type="text" id="teamSearch-filtered" class="form-control" placeholder="Search for teams...">
                    </div>
                    <div class="col-md-3">
                        <select id="seasonFilter-filtered" class="form-select">
                            <option value="all">All Seasons</option>
                            <option value="2019-20">2024-25</option>
                            <option value="2023-24">2023-24</option>
                            <option value="2022-23">2022-23</option>
                            <option value="2021-22">2021-22</option>
                            <option value="2020-21">2020-21</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select id="plotTypeFilter-filtered" class="form-select">
                            <option value="all">All Plot Types</option>
                            <option value="network">Network Plots</option>
                            <option value="community">Community Plots</option>
                            <option value="hierarchy">Hierarchy Plots</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button id="applyFilters-filtered" class="btn btn-primary">Apply Filters</button>
                    </div>
                </div>
                <div class="mt-2 button-group">
                    <button id="expandAll-filtered" class="btn btn-sm btn-outline-secondary">Expand All</button>
                    <button id="collapseAll-filtered" class="btn btn-sm btn-outline-secondary">Collapse All</button>
                </div>
            </div>

            <div id="seasons-filtered">
                <!-- 動態生成賽季內容 -->
            </div>
        </div>
    </div>

    <!-- CSV 資料顯示模態框 -->
    <div class="modal fade" id="csvModal" tabindex="-1" aria-labelledby="csvModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="csvModalLabel">CSV Data</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="csvLoadingSpinner" class="loading-spinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading data...</p>
                    </div>
                    <div id="csvErrorMessage" class="error-message hidden"></div>
                    <div id="mockDataNotice" class="mock-data-notice hidden">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i> Unable to load the actual CSV file. Displaying mock data instead.
                    </div>
                    <button id="downloadCSV" class="btn btn-success download-btn hidden">
                        <i class="bi bi-download"></i> Download CSV
                    </button>
                    <div class="table-responsive">
                        <table id="csvTable" class="table table-striped table-bordered"></table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script>
        // NBA球隊資料
        const nbaTeams = [
            { code: "ATL", name: "Atlanta Hawks", logoId: "1610612737" },
            { code: "BOS", name: "Boston Celtics", logoId: "1610612738" },
            { code: "BKN", name: "Brooklyn Nets", logoId: "1610612751" },
            { code: "CHA", name: "Charlotte Hornets", logoId: "1610612766" },
            { code: "CHI", name: "Chicago Bulls", logoId: "1610612741" },
            { code: "CLE", name: "Cleveland Cavaliers", logoId: "1610612739" },
            { code: "DAL", name: "Dallas Mavericks", logoId: "1610612742" },
            { code: "DEN", name: "Denver Nuggets", logoId: "1610612743" },
            { code: "DET", name: "Detroit Pistons", logoId: "1610612765" },
            { code: "GSW", name: "Golden State Warriors", logoId: "1610612744" },
            { code: "HOU", name: "Houston Rockets", logoId: "1610612745" },
            { code: "IND", name: "Indiana Pacers", logoId: "1610612754" },
            { code: "LAC", name: "LA Clippers", logoId: "1610612746" },
            { code: "LAL", name: "Los Angeles Lakers", logoId: "1610612747" },
            { code: "MEM", name: "Memphis Grizzlies", logoId: "1610612763" },
            { code: "MIA", name: "Miami Heat", logoId: "1610612748" },
            { code: "MIL", name: "Milwaukee Bucks", logoId: "1610612749" },
            { code: "MIN", name: "Minnesota Timberwolves", logoId: "1610612750" },
            { code: "NOP", name: "New Orleans Pelicans", logoId: "1610612740" },
            { code: "NYK", name: "New York Knicks", logoId: "1610612752" },
            { code: "OKC", name: "Oklahoma City Thunder", logoId: "1610612760" },
            { code: "ORL", name: "Orlando Magic", logoId: "1610612753" },
            { code: "PHI", name: "Philadelphia 76ers", logoId: "1610612755" },
            { code: "PHX", name: "Phoenix Suns", logoId: "1610612756" },
            { code: "POR", name: "Portland Trail Blazers", logoId: "1610612757" },
            { code: "SAC", name: "Sacramento Kings", logoId: "1610612758" },
            { code: "SAS", name: "San Antonio Spurs", logoId: "1610612759" },
            { code: "TOR", name: "Toronto Raptors", logoId: "1610612761" },
            { code: "UTA", name: "Utah Jazz", logoId: "1610612762" },
            { code: "WAS", name: "Washington Wizards", logoId: "1610612764" }
        ];

        // 賽季列表
        const seasonsNoFilter = ["2024-25","2023-24", "2022-23", "2021-22", "2020-21"];
        const seasonsFiltered = ["2024-25","2023-24", "2022-23", "2021-22", "2020-21"];

        // 資料集路徑
        const datasetPaths = {
            "no-filter": "all_passes",
            "filtered": "filtered_passes"
        };

        // 全局變數，用於存儲當前CSV數據和檔案名稱
        let currentCSVData = null;
        let currentCSVFilename = '';
        let currentTeamFilter = '';

        // 切換資料集
        function switchDataset(datasetId) {
            // 更新標籤樣式
            document.getElementById('tab-no-filter').classList.remove('active');
            document.getElementById('tab-filtered').classList.remove('active');
            document.getElementById(`tab-${datasetId}`).classList.add('active');

            // 顯示/隱藏內容
            document.getElementById('content-no-filter').classList.add('hidden');
            document.getElementById('content-filtered').classList.add('hidden');
            document.getElementById(`content-${datasetId}`).classList.remove('hidden');
        }

        // 顯示 CSV 數據
        function showCSVData(csvPath, title, teamFilter = '') {
            currentCSVFilename = csvPath.split('/').pop();
            currentTeamFilter = teamFilter;

            // 設置模態框標題
            document.getElementById('csvModalLabel').textContent = title + (teamFilter ? ` - ${teamFilter}` : '');

            // 清空表格
            const table = document.getElementById('csvTable');
            table.innerHTML = '';

            // 顯示載入中訊息
            document.getElementById('csvLoadingSpinner').classList.remove('hidden');
            document.getElementById('csvErrorMessage').classList.add('hidden');
            document.getElementById('mockDataNotice').classList.add('hidden');
            document.getElementById('downloadCSV').classList.add('hidden');

            const modal = new bootstrap.Modal(document.getElementById('csvModal'));
            modal.show();

            // 嘗試讀取 CSV 檔案
            try {
                Papa.parse(csvPath, {
                    download: true,
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        document.getElementById('csvLoadingSpinner').classList.add('hidden');
                        document.getElementById('downloadCSV').classList.remove('hidden');
                        
                        // 如果有球隊過濾條件，則過濾數據
                        let filteredData = results.data;
                        if (teamFilter) {
                            filteredData = results.data.filter(row => row.team === teamFilter);
                        }
                        
                        currentCSVData = filteredData;
                        displayCSVTable(filteredData);
                    },
                    error: function(error) {
                        console.error('Error loading CSV:', error);
                        document.getElementById('csvLoadingSpinner').classList.add('hidden');
                        
                        // 顯示錯誤訊息
                        const errorElement = document.getElementById('csvErrorMessage');
                        errorElement.textContent = `Unable to load CSV file: ${csvPath}. Using mock data instead.`;
                        errorElement.classList.remove('hidden');
                        
                        // 顯示模擬數據提示
                        document.getElementById('mockDataNotice').classList.remove('hidden');
                        document.getElementById('downloadCSV').classList.remove('hidden');
                        
                        // 生成模擬數據
                        let mockData = generateMockCSVData(csvPath);
                        
                        // 如果有球隊過濾條件，則過濾數據
                        if (teamFilter) {
                            mockData = mockData.filter(row => row.team === teamFilter);
                        }
                        
                        currentCSVData = mockData;
                        displayCSVTable(mockData);
                    }
                });
            } catch (e) {
                console.error('Exception when loading CSV:', e);
                document.getElementById('csvLoadingSpinner').classList.add('hidden');
                
                // 顯示錯誤訊息
                const errorElement = document.getElementById('csvErrorMessage');
                errorElement.textContent = `Exception when loading CSV file: ${e.message}. Using mock data instead.`;
                errorElement.classList.remove('hidden');
                
                // 顯示模擬數據提示
                document.getElementById('mockDataNotice').classList.remove('hidden');
                document.getElementById('downloadCSV').classList.remove('hidden');
                
                // 生成模擬數據
                let mockData = generateMockCSVData(csvPath);
                
                // 如果有球隊過濾條件，則過濾數據
                if (teamFilter) {
                    mockData = mockData.filter(row => row.team === teamFilter);
                }
                
                currentCSVData = mockData;
                displayCSVTable(mockData);
            }
        }

        // 顯示 CSV 表格
        function displayCSVTable(data) {
            const table = document.getElementById('csvTable');

            // 創建表格頭
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');

            if (data.length > 0) {
                Object.keys(data[0]).forEach(key => {
                    const th = document.createElement('th');
                    th.textContent = key;
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);
                table.appendChild(thead);

                // 創建表格體
                const tbody = document.createElement('tbody');
                data.forEach(row => {
                    const tr = document.createElement('tr');
                    Object.values(row).forEach(value => {
                        const td = document.createElement('td');
                        td.textContent = value;
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                });
                table.appendChild(tbody);

                // 初始化 DataTables
                $(document).ready(function() {
                    if ($.fn.DataTable.isDataTable('#csvTable')) {
                        $('#csvTable').DataTable().destroy();
                    }
                    $('#csvTable').DataTable({
                        paging: true,
                        searching: true,
                        ordering: true,
                        info: true,
                        pageLength: 10,
                        lengthMenu: [10, 25, 50, 100],
                        responsive: true
                    });
                });
            } else {
                // 沒有數據
                table.innerHTML = '<div class="alert alert-warning">No data available</div>';
            }
        }

        // 生成模擬 CSV 數據
        function generateMockCSVData(csvPath) {
            const mockData = [];
            const isSeasonData = csvPath.includes('/20');
            const isAllSeasons = csvPath.includes('all_seasons');

            // 根據路徑判斷要生成什麼類型的模擬數據
            if (isAllSeasons) {
                // 所有賽季的數據
                seasonsNoFilter.forEach(season => {
                    nbaTeams.forEach(team => {
                        mockData.push({
                            season: season,
                            team: team.code,
                            team_name: team.name,
                            density: (Math.random() * 0.3 + 0.3).toFixed(3),
                            transitivity: (Math.random() * 0.3 + 0.2).toFixed(3),
                            reciprocity: (Math.random() * 0.3 + 0.5).toFixed(3),
                            avg_degree: (Math.random() * 3 + 3).toFixed(2),
                            avg_weighted_degree: (Math.random() * 10 + 8).toFixed(2),
                            diameter: Math.floor(Math.random() * 2 + 3),
                            avg_path_length: (Math.random() + 1.5).toFixed(2),
                            walktrap_communities: Math.floor(Math.random() * 2 + 2),
                            walktrap_modularity: (Math.random() * 0.3 + 0.2).toFixed(3),
                            edge_betweenness_communities: Math.floor(Math.random() * 2 + 2),
                            edge_betweenness_modularity: (Math.random() * 0.3 + 0.2).toFixed(3),
                            louvain_communities: Math.floor(Math.random() * 2 + 2),
                            louvain_modularity: (Math.random() * 0.3 + 0.2).toFixed(3),
                            cohesive_blocks: Math.floor(Math.random() * 3 + 2),
                            max_cohesion: Math.floor(Math.random() * 3 + 1),
                            hierarchy_depth: Math.floor(Math.random() * 2 + 2)
                        });
                    });
                });
            } else if (isSeasonData) {
                // 單一賽季的數據
                nbaTeams.forEach(team => {
                    mockData.push({
                        team: team.code,
                        team_name: team.name,
                        density: (Math.random() * 0.3 + 0.3).toFixed(3),
                        transitivity: (Math.random() * 0.3 + 0.2).toFixed(3),
                        reciprocity: (Math.random() * 0.3 + 0.5).toFixed(3),
                        avg_degree: (Math.random() * 3 + 3).toFixed(2),
                        avg_weighted_degree: (Math.random() * 10 + 8).toFixed(2),
                        diameter: Math.floor(Math.random() * 2 + 3),
                        avg_path_length: (Math.random() + 1.5).toFixed(2),
                        walktrap_communities: Math.floor(Math.random() * 2 + 2),
                        walktrap_modularity: (Math.random() * 0.3 + 0.2).toFixed(3),
                        edge_betweenness_communities: Math.floor(Math.random() * 2 + 2),
                        edge_betweenness_modularity: (Math.random() * 0.3 + 0.2).toFixed(3),
                        louvain_communities: Math.floor(Math.random() * 2 + 2),
                        louvain_modularity: (Math.random() * 0.3 + 0.2).toFixed(3),
                        cohesive_blocks: Math.floor(Math.random() * 3 + 2),
                        max_cohesion: Math.floor(Math.random() * 3 + 1),
                        hierarchy_depth: Math.floor(Math.random() * 2 + 2)
                    });
                });
            }

            return mockData;
        }

        // 下載 CSV 檔案
        document.getElementById('downloadCSV').addEventListener('click', function() {
            if (currentCSVData) {
                const csv = Papa.unparse(currentCSVData);
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', currentCSVFilename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        });

        // 生成球隊HTML
        function generateTeamHTML(team, season, datasetId) {
            const basePath = datasetPaths[datasetId];
            return `
            <div class="team-section" data-team="${team.code}">
                <div class="team-header" onclick="toggleSection('team-${season}-${team.code}-${datasetId}')">
                    <i class="bi bi-chevron-right chevron-icon"></i>
                    <img src="https://cdn.nba.com/logos/nba/${team.logoId}/global/L/logo.svg" alt="${team.name}" class="team-logo">
                    ${team.name} (${team.code})
                </div>
                <div id="team-${season}-${team.code}-${datasetId}" class="team-content hidden">
                    <div class="plot-category network-plot">Network Plots:</div>
                    <div class="plot-links">
                        <a href="${basePath}/${season}/plots/network_plots/${team.code}_pass_network.png" target="_blank">Pass Network</a>
                    </div>
                    
                    <div class="plot-category community-plot">Community Detection:</div>
                    <div class="plot-links">
                        <a href="${basePath}/${season}/plots/community_plots/${team.code}_walktrap.png" target="_blank">Walktrap</a> | 
                        <a href="${basePath}/${season}/plots/community_plots/${team.code}_edge_betweenness.png" target="_blank">Edge Betweenness</a> | 
                        <a href="${basePath}/${season}/plots/community_plots/${team.code}_louvain.png" target="_blank">Louvain</a>
                    </div>
                    
                    <div class="plot-category hierarchy-plot">Hierarchy Analysis:</div>
                    <div class="plot-links">
                        <a href="${basePath}/${season}/plots/hierarchy_plots/${team.code}_hierarchy.png" target="_blank">Cohesive Blocks</a>
                    </div>
                    

		        
		        <!-- 修改網絡指標連結 -->
		        <a href="javascript:void(0);" class="network-indicators-link" onclick="showCSVData('${basePath}/${season}/network_metrics.csv', '${season} Regular Season Passing Network Indicators ${datasetId === 'filtered' ? '(Filtered passes)' : '(all passes)'}', '${team.code}')">
		            <i class="bi bi-bar-chart-line"></i> Network Indicators
		        </a>
		        
		        <div id="team-data-${season}-${team.code}-${datasetId}"></div>
		    </div>`;




        }

		// 生成賽季HTML
		// 修改 generateSeasonHTML 函數中的 csv-link 部分
		function generateSeasonHTML(season, datasetId) {
		    const basePath = datasetPaths[datasetId];
		    const isHidden = true; // 所有賽季預設都是收合的
		    const hiddenClass = isHidden ? 'hidden' : '';
		    
		    return `
		    <div class="season-section" data-season="${season}">
		        <div class="season-header" onclick="toggleSection('season-${season}-${datasetId}')">
		            <div>
		                <i class="bi bi-chevron-right chevron-icon"></i> ${season} Regular Season
		            </div>
		            <a href="javascript:void(0);" class="csv-link" onclick="showCSVData('${basePath}/${season}/network_metrics.csv', '${season} Regular Season Passing Network Indicators ${datasetId === 'filtered' ? '(Filtered passes)' : '(all passes)'}')">
		                <i class="bi bi-file-earmark-spreadsheet"></i> View Season CSV
		            </a>
		        </div>
		        <div id="season-${season}-${datasetId}" class="season-content ${hiddenClass}">
		            <!-- 動態生成所有球隊 -->
		        </div>
		    </div>`;
		}



        // 初始化頁面
        function initializePage() {
            // 初始化無篩選資料
            const seasonsNoFilterContainer = document.getElementById('seasons-no-filter');
            let noFilterHTML = '';
            seasonsNoFilter.forEach(season => {
                noFilterHTML += generateSeasonHTML(season, 'no-filter');
            });
            seasonsNoFilterContainer.innerHTML = noFilterHTML;
            
            // 初始化已篩選資料
            const seasonsFilteredContainer = document.getElementById('seasons-filtered');
            let filteredHTML = '';
            seasonsFiltered.forEach(season => {
                filteredHTML += generateSeasonHTML(season, 'filtered');
            });
            seasonsFilteredContainer.innerHTML = filteredHTML;
            
            // 為每個賽季添加球隊
            seasonsNoFilter.forEach(season => {
                const seasonContent = document.getElementById(`season-${season}-no-filter`);
                let teamsHTML = '';
                nbaTeams.forEach(team => {
                    teamsHTML += generateTeamHTML(team, season, 'no-filter');
                });
                seasonContent.innerHTML = teamsHTML;
            });
            
            seasonsFiltered.forEach(season => {
                const seasonContent = document.getElementById(`season-${season}-filtered`);
                if (seasonContent) { // 確保元素存在
                    let teamsHTML = '';
                    nbaTeams.forEach(team => {
                        teamsHTML += generateTeamHTML(team, season, 'filtered');
                    });
                    seasonContent.innerHTML = teamsHTML;
                }
            });
        }

        // 切換區段顯示/隱藏
        function toggleSection(id) {
            const element = document.getElementById(id);
            if (element.classList.contains('hidden')) {
                element.classList.remove('hidden');
                
                // 更改箭頭方向
                const icon = element.previousElementSibling.querySelector('i.chevron-icon');
                icon.classList.remove('bi-chevron-right');
                icon.classList.add('bi-chevron-down');
            } else {
                element.classList.add('hidden');
                
                // 更改箭頭方向
                const icon = element.previousElementSibling.querySelector('i.chevron-icon');
                icon.classList.remove('bi-chevron-down');
                icon.classList.add('bi-chevron-right');
            }
        }

        // 處理過濾器功能
        function setupFilters(datasetId) {
            // 展開所有區段
            document.getElementById(`expandAll-${datasetId}`).addEventListener('click', function() {
                const container = document.getElementById(`content-${datasetId}`);
                const hiddenElements = container.querySelectorAll('.hidden');
                hiddenElements.forEach(element => {
                    element.classList.remove('hidden');
                    
                    // 更改箭頭方向
                    if (element.previousElementSibling && element.previousElementSibling.querySelector('i.chevron-icon')) {
                        const icon = element.previousElementSibling.querySelector('i.chevron-icon');
                        icon.classList.remove('bi-chevron-right');
                        icon.classList.add('bi-chevron-down');
                    }
                });
            });

            // 收起所有區段
            document.getElementById(`collapseAll-${datasetId}`).addEventListener('click', function() {
                const container = document.getElementById(`content-${datasetId}`);
                
                // 收起賽季，但保持最新賽季開啟
                const seasonContents = container.querySelectorAll('.season-content');
                seasonContents.forEach(element => {
                    // 確定是否為最新賽季
                    const isLatestSeason = element.id.includes('2023-24') || 
                                         (datasetId === 'filtered' && element.id.includes('2022-23'));
                    
                    if (!isLatestSeason) {
                        element.classList.add('hidden');
                        
                        // 更改箭頭方向
                        if (element.previousElementSibling && element.previousElementSibling.querySelector('i.chevron-icon')) {
                            const icon = element.previousElementSibling.querySelector('i.chevron-icon');
                            icon.classList.remove('bi-chevron-down');
                            icon.classList.add('bi-chevron-right');
                        }
                    }
                });
                
                // 收起所有球隊
                const teamContents = container.querySelectorAll('.team-content');
                teamContents.forEach(element => {
                    element.classList.add('hidden');
                    
                    // 更改箭頭方向
                    if (element.previousElementSibling && element.previousElementSibling.querySelector('i.chevron-icon')) {
                        const icon = element.previousElementSibling.querySelector('i.chevron-icon');
                        icon.classList.remove('bi-chevron-down');
                        icon.classList.add('bi-chevron-right');
                    }
                });
            });

            // 應用過濾器
            document.getElementById(`applyFilters-${datasetId}`).addEventListener('click', function() {
                const container = document.getElementById(`content-${datasetId}`);
                const teamSearch = document.getElementById(`teamSearch-${datasetId}`).value.toUpperCase();
                const seasonFilter = document.getElementById(`seasonFilter-${datasetId}`).value;
                const plotTypeFilter = document.getElementById(`plotTypeFilter-${datasetId}`).value;

                // 過濾賽季
                const seasonSections = container.querySelectorAll('.season-section');
                seasonSections.forEach(section => {
                    const seasonValue = section.getAttribute('data-season');
                    if (seasonFilter === 'all' || seasonFilter === seasonValue) {
                        section.style.display = 'block';
                        
                        // 如果有篩選條件，自動展開賽季
                        if (seasonFilter !== 'all' || teamSearch !== '') {
                            const seasonContent = section.querySelector('.season-content');
                            seasonContent.classList.remove('hidden');
                            const icon = section.querySelector('.season-header i.chevron-icon');
                            icon.classList.remove('bi-chevron-right');
                            icon.classList.add('bi-chevron-down');
                        }
                    } else {
                        section.style.display = 'none';
                    }
                });

                // 過濾球隊
                const teamSections = container.querySelectorAll('.team-section');
                teamSections.forEach(section => {
                    const teamValue = section.getAttribute('data-team');
                    const teamHeader = section.querySelector('.team-header').textContent;
                    if (teamSearch === '' || teamValue.includes(teamSearch) || teamHeader.toUpperCase().includes(teamSearch)) {
                        section.style.display = 'block';
                        
                        // 如果有搜尋條件，自動展開球隊
                        if (teamSearch !== '') {
                            const teamContent = section.querySelector('.team-content');
                            teamContent.classList.remove('hidden');
                            const icon = section.querySelector('.team-header i.chevron-icon');
                            icon.classList.remove('bi-chevron-right');
                            icon.classList.add('bi-chevron-down');
                        }
                    } else {
                        section.style.display = 'none';
                    }
                });

                // 過濾圖表類型
                if (plotTypeFilter !== 'all') {
                    const plotCategories = container.querySelectorAll('.plot-category');
                    plotCategories.forEach(category => {
                        if (category.classList.contains(`${plotTypeFilter}-plot`)) {
                            category.style.display = 'block';
                            category.nextElementSibling.style.display = 'block';
                        } else {
                            category.style.display = 'none';
                            category.nextElementSibling.style.display = 'none';
                        }
                    });
                } else {
                    // 顯示所有圖表類型
                    const plotCategories = container.querySelectorAll('.plot-category');
                    plotCategories.forEach(category => {
                        category.style.display = 'block';
                        category.nextElementSibling.style.display = 'block';
                    });
                }
            });
        }

        // 頁面載入時初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
            setupFilters('no-filter');
            setupFilters('filtered');
            
            
            // 處理模態框關閉時銷毀 DataTable
            $('#csvModal').on('hidden.bs.modal', function () {
                if ($.fn.DataTable.isDataTable('#csvTable')) {
                    $('#csvTable').DataTable().destroy();
                }
            });
        });
    </script>
</body>
</html>
